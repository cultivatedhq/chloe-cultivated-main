# Complete Bolt Workflow Setup for Survey Processing

## Block 1: Get Survey Data
**Type:** Supabase SQL Query
**Query:**
```sql
SELECT * FROM feedback_sessions WHERE id = '{{ survey_id }}'
```
**Output Variable:** `survey`

## Block 2: Get Responses
**Type:** Supabase SQL Query  
**Query:**
```sql
SELECT * FROM feedback_responses WHERE session_id = '{{ survey_id }}'
```
**Output Variable:** `responses`

## Block 3: Process Survey Data
**Type:** Logic/JavaScript
**Code:** (Use your provided code)
```javascript
const questionStats = {};
const comments = [];
const ssk = { start: [], stop: [], keep: [] };

responses.forEach(r => {
  Object.entries(r.answers || {}).forEach(([q, val]) => {
    if (!questionStats[q]) questionStats[q] = [];
    questionStats[q].push(Number(val));
  });

  if (r.comment) comments.push(r.comment);
  if (r.start) ssk.start.push(r.start);
  if (r.stop) ssk.stop.push(r.stop);
  if (r.keep) ssk.keep.push(r.keep);
});

const questions = Object.entries(questionStats).map(([text, scores]) => {
  const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
  const sorted = [...scores].sort((a, b) => a - b);
  const median = sorted[Math.floor(scores.length / 2)];
  const dist = [1,2,3,4,5].reduce((acc, n) => {
    acc[n] = scores.filter(s => s === n).length;
    return acc;
  }, {});
  return { text, avg: avg.toFixed(2), median, dist };
});

const top = questions.reduce((a, b) => (a.avg > b.avg ? a : b));
const low = questions.reduce((a, b) => (a.avg < b.avg ? a : b));
const avg_score = questions.reduce((s, q) => s + parseFloat(q.avg), 0) / questions.length;
const avg_score_percent = Math.round((avg_score / 5) * 100);

return {
  total_responses: responses.length,
  questions,
  top_question: top.text,
  top_score: top.avg,
  lowest_question: low.text,
  low_score: low.avg,
  avg_score: avg_score.toFixed(2),
  avg_score_percent,
  comment_count: comments.length,
  comments,
  ssk: {
    start: ssk.start.join(', '),
    stop: ssk.stop.join(', '),
    keep: ssk.keep.join(', ')
  }
};
```
**Output Variable:** `processedData`

## Block 4: Set Variables
**Type:** Set Variable (create multiple blocks)

### Variable 1: total_responses
**Value:** `{{ processedData.total_responses }}`

### Variable 2: avg_score
**Value:** `{{ processedData.avg_score }}`

### Variable 3: avg_score_percent  
**Value:** `{{ processedData.avg_score_percent }}`

### Variable 4: top_question
**Value:** `{{ processedData.top_question }}`

### Variable 5: top_score
**Value:** `{{ processedData.top_score }}`

### Variable 6: lowest_question
**Value:** `{{ processedData.lowest_question }}`

### Variable 7: low_score
**Value:** `{{ processedData.low_score }}`

### Variable 8: questions
**Value:** `{{ processedData.questions }}`

### Variable 9: comments
**Value:** `{{ processedData.comments }}`

### Variable 10: ssk
**Value:** `{{ processedData.ssk }}`

## Block 5: Build HTML Report
**Type:** Set Variable
**Variable Name:** `report_html`
**Value:**
```html
<!DOCTYPE html>
<html>
<head>
    <title>Leadership Feedback Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { text-align: center; border-bottom: 2px solid #2a9d8f; padding-bottom: 20px; }
        .section { margin: 30px 0; }
        .question { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; }
        .score { font-weight: bold; color: #2a9d8f; }
        .comment { background: #e8f5e8; padding: 10px; margin: 10px 0; border-left: 4px solid #2a9d8f; }
        .ssk-section { background: #f0f8ff; padding: 20px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Leadership Feedback Report</h1>
        <p>Generated by Cultivated HQ</p>
    </div>
    
    <div class="section">
        <h2>Summary</h2>
        <p><strong>Total Responses:</strong> {{ total_responses }}</p>
        <p><strong>Overall Score:</strong> {{ avg_score_percent }}% ({{ avg_score }}/5)</p>
        <p><strong>Strongest Area:</strong> {{ top_question }} ({{ top_score }})</p>
        <p><strong>Development Area:</strong> {{ lowest_question }} ({{ low_score }})</p>
    </div>
    
    <div class="section">
        <h2>Question Results</h2>
        {{#each questions}}
        <div class="question">
            <h3>{{ this.text }}</h3>
            <p>Average: <span class="score">{{ this.avg }}/5</span> | Median: {{ this.median }}</p>
            <p>Distribution: 
                {{#each this.dist}}
                {{ @key }}â˜…: {{ this }} 
                {{/each}}
            </p>
        </div>
        {{/each}}
    </div>
    
    {{#if ssk.start}}
    <div class="section">
        <h2>Start/Stop/Keep Feedback</h2>
        <div class="ssk-section">
            {{#if ssk.start}}<p><strong>Start Doing:</strong> {{ ssk.start }}</p>{{/if}}
            {{#if ssk.stop}}<p><strong>Stop Doing:</strong> {{ ssk.stop }}</p>{{/if}}
            {{#if ssk.keep}}<p><strong>Keep Doing:</strong> {{ ssk.keep }}</p>{{/if}}
        </div>
    </div>
    {{/if}}
    
    {{#if comments}}
    <div class="section">
        <h2>Additional Comments</h2>
        {{#each comments}}
        <div class="comment">{{ this }}</div>
        {{/each}}
    </div>
    {{/if}}
    
    <div class="section">
        <p><em>Generated on {{ date }} | Cultivated HQ</em></p>
    </div>
</body>
</html>
```

## Block 6: Generate PDF
**Type:** HTTP Request
**Method:** POST
**URL:** `https://api.pdf.co/v1/pdf/convert/from/html`
**Headers:**
```json
{
  "x-api-key": "cbjames674@gmail.com_C8Qxi0EeYZPsuFleKhRErEynYQ12d16f2TttcgYaMpKOtP3aHlBHTNvG64EynWbR",
  "Content-Type": "application/json"
}
```
**Body:**
```json
{
  "html": "{{ report_html }}",
  "name": "Leadership-Feedback-Report.pdf",
  "async": false,
  "margins": "20px",
  "paperSize": "A4",
  "orientation": "Portrait"
}
```
**Output Variable:** `pdf_response`

## Block 7: Send Email
**Type:** Email
**To:** `{{ survey.manager_email }}, chloe@cultivatedhq.com.au`
**Subject:** `Your Leadership Feedback Report is Ready`
**Body:**
```
Hi {{ survey.manager_name }},

Your leadership feedback report is ready! Here's a quick summary:

ðŸ“Š RESULTS SUMMARY:
â€¢ Total Responses: {{ total_responses }}
â€¢ Overall Leadership Score: {{ avg_score_percent }}%
â€¢ Strongest Area: {{ top_question }} ({{ top_score }}/5)
â€¢ Development Opportunity: {{ lowest_question }} ({{ low_score }}/5)

ðŸ“„ DOWNLOAD YOUR FULL REPORT:
{{ pdf_response.url }}

ðŸŽ¯ START/STOP/KEEP FEEDBACK:
{{#if ssk.start}}
START DOING: {{ ssk.start }}
{{/if}}
{{#if ssk.stop}}
STOP DOING: {{ ssk.stop }}
{{/if}}
{{#if ssk.keep}}
KEEP DOING: {{ ssk.keep }}
{{/if}}

Your detailed PDF report includes:
âœ… Complete statistical analysis
âœ… Question-by-question breakdown
âœ… Anonymous team comments
âœ… Development recommendations

Thank you for investing in your leadership development!

Best regards,
Chloe James
Cultivated HQ
```